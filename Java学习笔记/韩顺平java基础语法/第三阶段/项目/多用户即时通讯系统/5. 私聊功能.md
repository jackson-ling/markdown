---
aside: right
outline: [2, 3]
---

<h1 style="text-align: center; font-weight: bold;">ç§èŠåŠŸèƒ½</h1>

---

##### è®¾è®¡æ€è·¯ï¼ˆ<span style = "color:red;font-weight:bold">éå¸¸é‡è¦ï¼ï¼ï¼</span>ï¼‰

![alt text](è®¾è®¡æ€è·¯.png)

## 1. ç§èŠæ€è·¯åˆ†æ

![alt text](ç§èŠæ€è·¯åˆ†æ.png)

## 2. å®¢æˆ·ç«¯

### MessageClientService

åœ¨ service åŒ…ä¸‹ç¼–å†™è¿™ä¸ªç±»ï¼Œç”¨äºç§èŠåŠŸèƒ½

```java
package service;

import common.Message;
import common.MessageType;

import java.io.IOException;
import java.io.ObjectOutputStream;
import java.util.Date;

public class MessageClientService {

    // ç§èŠåŠŸèƒ½ï¼Œå‘é€ä¿¡æ¯
    public void sendMessageToOne(String content,String senderId,String getterId){
        Message message = new Message();
        message.setMesType(MessageType.MESSAGE_COMM_MES); // è®¾ç½®æ¶ˆæ¯ç±»å‹
        message.setSender(senderId);
        message.setGetter(getterId);
        message.setContent(content);
        message.setSendTime(new Date().toString()); // è®¾ç½®å‘é€æ—¶é—´
        System.out.println(senderId + " å¯¹ " + getterId + " è¯´ " + content);

        // å‘é€ç»™æœåŠ¡ç«¯
        try {
            ObjectOutputStream oos = new ObjectOutputStream(ManagerClientConnectServerThread.getClientConnectServerThread(senderId).getSocket().getOutputStream());
            oos.writeObject(message);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}

```

### QQView

ç§èŠåŠŸèƒ½åœ¨ç”¨æˆ·ç•Œé¢ä¸Šçš„å®ç°

```java
// ç§èŠ
private MessageClientService messageClientService = new MessageClientService();

 case "3":
    System.out.print("è¯·è¾“å…¥æƒ³èŠå¤©çš„ç”¨æˆ·å·ï¼ˆåœ¨çº¿ï¼‰ï¼š");
    String getterId = Utility.readString(50);
    System.out.print("è¯·è¾“å…¥æƒ³è¯´çš„è¯ï¼š");
    String content = Utility.readString(100);
    // è°ƒç”¨æ–¹æ³•ï¼ŒæŠŠä¿¡æ¯å‘é€ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è½¬å‘ä¿¡æ¯
    messageClientService.sendMessageToOne(content,userId,getterId);
    break;
```

### ClientConnectServerThread

æ¥æ”¶åˆ°å¯¹æ–¹å‘æ¥çš„ä¿¡æ¯ï¼Œéœ€è¦åœ¨æ§åˆ¶å°ä¸Šæ˜¾ç¤º

```java
    @Override
    public void run() {
        // åœ¨åå°å’ŒæœåŠ¡å™¨é€šè®¯
        while (true){
            System.out.println("ç­‰å¾…è¯»å–æœåŠ¡ç«¯çš„ä¿¡æ¯...");
            try {
                    ...
                // æ¥æ”¶æœåŠ¡å™¨å›é€çš„ä¿¡æ¯ï¼šåœ¨çº¿ç”¨æˆ·åˆ—è¡¨
                if(message.getMesType().equals(MessageType.MESSAGE_RET_ONLINE_FRIEND)){
                        ...
                    }
                }else if (message.getMesType().equals(MessageType.MESSAGE_COMM_MES)){
                    System.out.println("\n" + message.getSender() + " å¯¹ " + message.getGetter() + "è¯´ï¼š" + message.getContent());
                }
                else{
                    System.out.println("æ˜¯å…¶ä»–ç±»å‹çš„ messageï¼Œæš‚æ—¶ä¸å¤„ç†...");
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
```

## 3. æœåŠ¡ç«¯

**ServerConnectClientThread** ç±»ä¸­è¡¥å……æ¥æ”¶ç”¨æˆ·å‘æ¥çš„ä¿¡æ¯ï¼Œæ‰“åŒ…æˆ message å¯¹è±¡å‘ç»™å¯¹æ–¹ï¼ŒåŒæ—¶**è¡¥å…… getSocket()** æ–¹æ³•

```java
public Socket getSocket() {
    return socket;
}

 @Override
    public void run() { // çº¿ç¨‹ï¼Œå¯ä»¥ç»™å®¢æˆ·ç«¯å‘é€ä¿¡æ¯æˆ–è€…æ¥æ”¶å®¢æˆ·ç«¯çš„ä¿¡æ¯
        while (true) {
            System.out.println("æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯" + userId + "ä¿æŒé€šä¿¡ï¼Œè¯»å–æ•°æ®ä¸­...");
            try {
                    ...

                // æ¥æ”¶ç”¨æˆ·ç«¯å‘é€çš„ä¿¡æ¯ï¼Œåšç›¸åº”çš„å¤„ç†
                if (message.getMesType().equals(MessageType.MESSAGE_GET_ONLINE_FRIEND)) {
                    ...

                } else if (message.getMesType().equals(MessageType.MESSAGE_CLIENT_EXIT)){
                    ...
                } else if (message.getMesType().equals(MessageType.MESSAGE_COMM_MES)){
                    // æ ¹æ® message è·å– userId
                    ServerConnectClientThread serverConnectClientThread = ManageClientThreads.getServerConnectClientThread(message.getGetter());
                    // å¾—åˆ° socket è¾“å‡ºæµï¼Œè½¬å‘ä¿¡æ¯
                    ObjectOutputStream oos = new ObjectOutputStream(serverConnectClientThread.getSocket().getOutputStream());
                    oos.writeObject(message); // è½¬å‘ä¿¡æ¯
                }
                else {
                    System.out.println("å…¶ä»–ç±»å‹çš„messageï¼Œæš‚æ—¶ä¸å¤„ç†");
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

```

## ğŸ‰ å®Œç»“ï¼šåŠŸèƒ½æµ‹è¯• ğŸ‰

### 1.å®¢æˆ·ç«¯ä¸€

![alt text](ç§èŠæµ‹è¯•ï¼šç”¨æˆ·ç«¯ä¸€.png)

### 2. å®¢æˆ·ç«¯äºŒ

![alt text](ç§èŠæµ‹è¯•ï¼šç”¨æˆ·ç«¯äºŒ.png)
