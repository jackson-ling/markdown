---
aside: right
outline: [2, 3]
---

<h1 style="text-align: center; font-weight: bold;">æ— å¼‚å¸¸é€€å‡º</h1>

---

##### è®¾è®¡æ€è·¯ï¼ˆ<span style = "color:red;font-weight:bold">éå¸¸é‡è¦ï¼ï¼ï¼</span>ï¼‰

![alt text](è®¾è®¡æ€è·¯.png)

<span style = "color:red;font-size:30px;font-weight:bold;">é˜¶æ®µä»»åŠ¡ï¼šè§£å†³ç”¨æˆ·é€€å‡ºæŠ›å‡ºå¼‚å¸¸çš„é—®é¢˜</span>

#### ä¸¤ä¸ªé—®é¢˜

- **ç”¨æˆ·ç«¯**ï¼šé€€å‡ºåè¿›ç¨‹æ²¡æœ‰é€€å‡º
- **æœåŠ¡ç«¯**ï¼šç”±äºç”¨æˆ·ç«¯é€€å‡ºäº†ï¼Œä½†æ˜¯ socket é€šé“å’Œçº¿ç¨‹ä»æœªå…³é—­ï¼Œä¼š<span style ="color:red;font-weight:bold">æŠ›å‡ºå¤§é‡çš„ IO å¼‚å¸¸</span>

#### æ€è·¯åˆ†æ

![alt text](æ— å¼‚å¸¸é€€å‡ºæ€è·¯.png)

### ï¼ˆ1ï¼‰å®¢æˆ·ç«¯

#### 1. åœ¨ UserClientService ä¸­ç¼–å†™é€€å‡ºæ–¹æ³•ï¼Œç»™æœåŠ¡å™¨å‘é€é€€å‡ºçš„ä¿¡æ¯

```java
//ç¼–å†™æ–¹æ³•ï¼Œé€€å‡ºå®¢æˆ·ç«¯ï¼Œå¹¶ç»™æœåŠ¡ç«¯å‘é€ä¸€ä¸ªé€€å‡ºç³»ç»Ÿçš„messageå¯¹è±¡
public void logout() {
    // æ„å»º message å¯¹è±¡
    Message message = new Message();
    message.setMesType(MessageType.MESSAGE_CLIENT_EXIT);
    message.setSender(u.getUserId());//ä¸€å®šè¦æŒ‡å®šæˆ‘æ˜¯å“ªä¸ªå®¢æˆ·ç«¯id

    //å‘é€message
    try {
        //ObjectOutputStream oos = new ObjectOutputStream(socket.getOutputStream());
        ObjectOutputStream oos =
                new ObjectOutputStream(ManagerClientConnectServerThread.getClientConnectServerThread(u.getUserId()).getSocket().getOutputStream());
        oos.writeObject(message);
        System.out.println(u.getUserId() + " é€€å‡ºç³»ç»Ÿ ");
        System.exit(0);//ç»“æŸè¿›ç¨‹
    } catch (IOException e) {
        e.printStackTrace();
    }
}
```

#### 2. åœ¨ä¸»æ–¹æ³•ä¸­è°ƒç”¨

```java
case "9":
    //è°ƒç”¨æ–¹æ³•ï¼Œç»™æœåŠ¡å™¨å‘é€ä¸€ä¸ªé€€å‡ºç³»ç»Ÿçš„message
    userClientService.logout();
    loop = false;
    break;
```

### ï¼ˆ2ï¼‰æœåŠ¡ç«¯

æ€è·¯ï¼šæ¥æ”¶å®¢æˆ·ç«¯é€€å‡ºçš„ä¿¡æ¯åï¼Œéœ€è¦ç»“æŸçº¿ç¨‹ï¼ŒåŒæ—¶æŠŠçº¿ç¨‹ä»é›†åˆä¸­ç§»é™¤ï¼Œå¹¶å…³é—­ socket

#### 1. ManageClientThreads

**è¡¥å……ç¼–å†™ä»çº¿ç¨‹ä¸­ç§»é™¤é›†åˆçš„æ–¹æ³•**

```java
// ç”¨æˆ·é€€å‡ºï¼Œçº¿ç¨‹ç»“æŸï¼ŒæŠŠçº¿ç¨‹ä»é›†åˆä¸­å–å‡º
public static void removeServerConnectClientThread(String userId){
    hm.remove(userId);
}
```

#### 2. ServerConnectClientThread

**ç¼–å†™æ–¹æ³•ï¼Œç»“æŸçº¿ç¨‹å¹¶å…³é—­ socket**

```java
@Override
    public void run() { // çº¿ç¨‹ï¼Œå¯ä»¥ç»™å®¢æˆ·ç«¯å‘é€ä¿¡æ¯æˆ–è€…æ¥æ”¶å®¢æˆ·ç«¯çš„ä¿¡æ¯
        while (true) {
            System.out.println("æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯" + userId + "ä¿æŒé€šä¿¡ï¼Œè¯»å–æ•°æ®ä¸­...");
            try {
                    ...

                // æ¥æ”¶ç”¨æˆ·ç«¯å‘é€çš„ä¿¡æ¯ï¼Œåšç›¸åº”çš„å¤„ç†
                if (message.getMesType().equals(MessageType.MESSAGE_GET_ONLINE_FRIEND)) {
                    ...
                } else if (message.getMesType().equals(MessageType.MESSAGE_CLIENT_EXIT)){
                    System.out.println(message.getSender() + " é€€å‡º");
                    // å°†çº¿ç¨‹ä»é›†åˆä¸­ç§»é™¤
                    ManageClientThreads.removeServerConnectClientThread(message.getSender());
                    socket.close(); // å…³é—­è¿æ¥
                    break; // é€€å‡ºçº¿ç¨‹
                }
                else {
                    System.out.println("å…¶ä»–ç±»å‹çš„messageï¼Œæš‚æ—¶ä¸å¤„ç†");
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
```

## ğŸ‰ å®Œç»“ï¼šåŠŸèƒ½æµ‹è¯• ğŸ‰

### 1. å®¢æˆ·ç«¯

![alt text](æ— å¼‚å¸¸é€€å‡ºæµ‹è¯•ï¼šå®¢æˆ·ç«¯.png)

### 2. æœåŠ¡ç«¯

![alt text](æ— å¼‚å¸¸é€€å‡ºæµ‹è¯•ï¼šæœåŠ¡ç«¯.png)
