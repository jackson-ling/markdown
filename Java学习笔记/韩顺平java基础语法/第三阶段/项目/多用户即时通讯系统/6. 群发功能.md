---
aside: right
outline: [2, 3]
---

<h1 style="text-align: center; font-weight: bold;">ç¾¤å‘åŠŸèƒ½</h1>

---

##### è®¾è®¡æ€è·¯ï¼ˆ<span style = "color:red;font-weight:bold">éå¸¸é‡è¦ï¼ï¼ï¼</span>ï¼‰

![alt text](è®¾è®¡æ€è·¯.png)

## æ€è·¯åˆ†æ

å…¶å®å°±æ˜¯ç§èŠåŠŸèƒ½çš„æ‰©å±•ï¼Œå½“æœåŠ¡ç«¯æ‹¿åˆ° socket ä¹‹åï¼Œé€šè¿‡éå†é›†åˆé‡Œçš„æ‰€ç”¨çº¿ç¨‹ï¼ˆé™¤äº†è‡ªå·±ï¼‰ï¼Œé€šè¿‡çº¿ç¨‹æ‹¿åˆ° socketï¼ŒæŠŠä¿¡æ¯å‘å‡ºå»

## 1. å®¢æˆ·ç«¯

### MessageType

é¦–å…ˆå¢åŠ ç¾¤å‘å±æ€§ï¼Œ<span style = "color:red;font-weight:bold">åœ¨å®¢æˆ·ç«¯ä¹Ÿæ˜¯ä¸€æ ·ï¼Œæ‹·è´ä¸€ä»½å³å¯</span>

```java
package common;

public interface MessageType {
    String MESSAGE_LOGIN_SUCCEED = "1"; // è¡¨ç¤ºç™»å½•æˆåŠŸ
    String MESSAGE_LOGIN_FAIL = "2"; // è¡¨ç¤ºç™»å½•å¤±è´¥
    String MESSAGE_COMM_MES = "3"; //æ™®é€šä¿¡æ¯åŒ…
    String MESSAGE_GET_ONLINE_FRIEND = "4"; //è¦æ±‚è¿”å›åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
    String MESSAGE_RET_ONLINE_FRIEND = "5"; //è¿”å›çš„åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
    String MESSAGE_CLIENT_EXIT = "6"; //å®¢æˆ·ç«¯è¯·æ±‚é€€å‡º
    String MESSAGE_TO_ALL_MES = "7"; // ç¾¤å‘æ¶ˆæ¯
}
```

ç¼–å†™ç¾¤å‘æ–¹æ³•

### MessageClientService

```java
// ç¾¤å‘æ¶ˆæ¯
public void sendMessageToAll(String content,String senderId){
    Message message = new Message();
    message.setMesType(MessageType.MESSAGE_TO_ALL_MES); // è®¾ç½®æ¶ˆæ¯ç±»å‹
    message.setSender(senderId);
    message.setContent(content);
    message.setSendTime(new Date().toString()); // è®¾ç½®å‘é€æ—¶é—´
    System.out.println(senderId + " å¯¹å¤§å®¶è¯´ï¼š" + content);

    // å‘é€ç»™æœåŠ¡ç«¯
    try {
        ObjectOutputStream oos = new ObjectOutputStream(ManagerClientConnectServerThread.getClientConnectServerThread(senderId).getSocket().getOutputStream());
        oos.writeObject(message);
    } catch (IOException e) {
        e.printStackTrace();
    }
```

### ClientConnectServerThread

åœ¨çº¿ç¨‹ä¸­æ¥æ”¶ç¾¤å‘çš„æ¶ˆæ¯ï¼ŒåŒæ—¶æ‰“å°åœ¨æ§åˆ¶å°

```java
@Override
public void run() {
    // åœ¨åå°å’ŒæœåŠ¡å™¨é€šè®¯
    while (true){
        System.out.println("ç­‰å¾…è¯»å–æœåŠ¡ç«¯çš„ä¿¡æ¯...");
        try {
                ...
            // æ¥æ”¶æœåŠ¡å™¨å›é€çš„ä¿¡æ¯ï¼šåœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            if(message.getMesType().equals(MessageType.MESSAGE_RET_ONLINE_FRIEND)){
                ...
            }else if (message.getMesType().equals(MessageType.MESSAGE_COMM_MES)){
                ...
            }else if (message.getMesType().equals(MessageType.MESSAGE_TO_ALL_MES)) {
                System.out.println("\n" + message.getSender() + "å¯¹å¤§å®¶è¯´ï¼š" + message.getContent());
            }
            else{
                System.out.println("æ˜¯å…¶ä»–ç±»å‹çš„ messageï¼Œæš‚æ—¶ä¸å¤„ç†...");
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

## 2. æœåŠ¡ç«¯

éå†çº¿ç¨‹é›†åˆï¼Œæ‹¿åˆ° socketï¼ŒæŠŠæ¶ˆæ¯è¿›è¡Œè½¬å‘

### ManageClientThreads

```java
// è¿”å› hashmap
public static HashMap<String,ServerConnectClientThread> getHm() {
    return hm;
}
```

### ServerConnectClientThread

ç¼–å†™æ–¹æ³•ï¼Œè¿”å›é›†åˆ

```java
else if (message.getMesType().equals(MessageType.MESSAGE_TO_ALL_MES)){
    // ç¾¤å‘æ¶ˆæ¯ï¼šéå†é›†åˆï¼ŒæŠŠæ‰€æœ‰çº¿ç¨‹çš„socketéƒ½å¾—åˆ°ï¼Œè½¬å‘messageå³å¯
    HashMap<String, ServerConnectClientThread> hm = ManageClientThreads.getHm();
    Iterator<String> iterator = hm.keySet().iterator();
    while (iterator.hasNext()){
        String onLineUserId = iterator.next().toString();
        // æ’é™¤ç¾¤å‘æ¶ˆæ¯çš„ç”¨æˆ·
        if(!onLineUserId.equals(message.getSender())){
            ObjectOutputStream oos = new ObjectOutputStream(hm.get(onLineUserId).getSocket().getOutputStream());
            oos.writeObject(message);
        }
    }
}
```

## ğŸ‰ å®Œç»“ï¼šåŠŸèƒ½æµ‹è¯• ğŸ‰

![alt text](ç¾¤å‘ä¿¡æ¯æµ‹è¯•.png)
