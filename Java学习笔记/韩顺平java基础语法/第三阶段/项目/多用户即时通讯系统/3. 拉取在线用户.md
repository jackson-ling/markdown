---
aside: right
outline: [2, 3]
---

<h1 style="text-align: center; font-weight: bold;">æ‹‰å–åœ¨çº¿ç”¨æˆ·</h1>

---

##### è®¾è®¡æ€è·¯ï¼ˆ<span style = "color:red;font-weight:bold">éå¸¸é‡è¦ï¼ï¼ï¼</span>ï¼‰

![alt text](è®¾è®¡æ€è·¯.png)

## è¯´æ˜

<span style = "color:red;font-size:20px;font-weight:bold;">å®ç°å¤šç”¨æˆ·çš„åŸç†æ˜¯é€šè¿‡çº¿ç¨‹ï¼Œæ‰€ä»¥æœ¬æ¨¡å—å†…å®¹ä¼šä»çº¿ç¨‹çš„è§’åº¦å‡ºå‘ï¼Œå®Œæˆä¿¡æ¯çš„äº¤äº’</span>

## part 1

<span style = "color:red;font-size:25px;font-weight:bold;">é˜¶æ®µä»»åŠ¡ï¼šç¼–å†™å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€æ‹‰å–åœ¨çº¿ç”¨æˆ·çš„è¯·æ±‚ï¼ŒåŒæ—¶ç¼–å†™æ¥æ”¶ä¿¡æ¯çš„ç›¸å…³é€»è¾‘</span>

### ï¼ˆ1ï¼‰MessageType æ‰©å±•

#### MessageType

```java
public interface MessageType {
    String MESSAGE_LOGIN_SUCCEED = "1"; // è¡¨ç¤ºç™»å½•æˆåŠŸ
    String MESSAGE_LOGIN_FAIL = "2"; // è¡¨ç¤ºç™»å½•å¤±è´¥
    String MESSAGE_COMM_MES = "3"; //æ™®é€šä¿¡æ¯åŒ…
    String MESSAGE_GET_ONLINE_FRIEND = "4"; //è¦æ±‚è¿”å›åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
    String MESSAGE_RET_ONLINE_FRIEND = "5"; //è¿”å›çš„åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
    String MESSAGE_CLIENT_EXIT = "6"; //å®¢æˆ·ç«¯è¯·æ±‚é€€å‡º
}
```

<span style="color:red;font-weight:bold;font-size:20px">æé†’ï¼šæœåŠ¡ç«¯ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæ‹·è´ä¸€ä»½</span>

### ï¼ˆ2ï¼‰UserClientService

ç¼–å†™ä¸€ä¸ªæ–¹æ³•ï¼Œå‘æœåŠ¡ç«¯å‘é€ä¿¡æ¯è¯·æ±‚åœ¨çº¿ç”¨æˆ·åˆ—è¡¨çš„é€»è¾‘ï¼Œç”±äºæŠŠ socket æ”¾åˆ°äº†çº¿ç¨‹ç»“åˆä¸­ï¼Œåè¿‡æ¥çœ‹ï¼Œå…ˆè¦ä»é›†åˆä¸­å–åˆ°çº¿ç¨‹ï¼Œä»çº¿ç¨‹ä¸­å–åˆ° socketï¼Œä¹‹åè·å–æµæ¥å®ç°ä¿¡æ¯äº¤äº’

```java
// æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
public void onlineFriend(){
    // å‘é€ä¸€ä¸ª Message
    Message message = new Message();
    message.setMesType(MessageType.MESSAGE_GET_ONLINE_FRIEND);
    message.setSender(u.getUserId()); //è®¾ç½®å‘é€äºº

    try {
        // ä»é›†åˆä¸­é€šè¿‡ userId å¾—åˆ°å¯¹åº”çš„çº¿ç¨‹
        ClientConnectServerThread clientConnectServerThread = ManagerClientConnectServerThread.getClientConnectServerThread(u.getUserId());

        // è·å– socket
        Socket socket = clientConnectServerThread.getSocket();

        // è·å–è¾“å‡ºæµ
        ObjectOutputStream oos = new ObjectOutputStream(socket.getOutputStream());

        // å‘é€ä¿¡æ¯
        oos.writeObject(message);

    } catch (IOException e) {
        e.printStackTrace();
    }

}
```

### ï¼ˆ3ï¼‰ClientConnectServerThread

åœ¨çº¿ç¨‹ä¸­è¡¥å……ï¼šç¼–å†™æ¥æ”¶æœåŠ¡ç«¯è¿”å›çš„åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ä¿¡æ¯

```java
@Override
public void run() {
    // åœ¨åå°å’ŒæœåŠ¡å™¨é€šè®¯
    while (true){
        System.out.println("ç­‰å¾…è¯»å–æœåŠ¡ç«¯çš„ä¿¡æ¯...");
        try {
              ...
            // æ¥æ”¶æœåŠ¡å™¨å›é€çš„ä¿¡æ¯ï¼šåœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            if(message.getMesType().equals(MessageType.MESSAGE_RET_ONLINE_FRIEND)){
                // å–å‡ºåœ¨æ–°åˆ—è¡¨ä¿¡æ¯
                String[] onlineUsers = message.getContent().split(" ");
                System.out.println("\n=======å½“å‰åœ¨çº¿ç”¨æˆ·åˆ—è¡¨=======");
                for (int i = 0; i < onlineUsers.length; i++) {
                    System.out.println("ç”¨æˆ·ï¼š" + onlineUsers[i]);
                }
            }else{
                System.out.println("æ˜¯å…¶ä»–ç±»å‹çš„ messageï¼Œæš‚æ—¶ä¸å¤„ç†...");
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### ï¼ˆ3ï¼‰QQView

åœ¨å¾ªç¯é€»è¾‘ä¸­è°ƒç”¨ç›¸åº”çš„æ–¹æ³•

```java
switch (key) {
    case "1":
        // ç»™æœåŠ¡ç«¯å‘é€æ‹‰å–åœ¨çº¿ç”¨æˆ·è¯·æ±‚ï¼Œé€šè¿‡çº¿ç¨‹æ¥æ”¶è¿”å›çš„ä¿¡æ¯
        userClientService.onlineFriend();
        break;
}
```

## part 2

<span style = "color:red;font-size:25px;font-weight:bold;">é˜¶æ®µä»»åŠ¡ï¼šç¼–å†™æœåŠ¡ç«¯æ¥æ”¶ç”¨æˆ·ç«¯æ‹‰å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨çš„è¯·æ±‚ï¼Œå¹¶æŠŠä¿¡æ¯è¿”å›</span>

### ï¼ˆ1ï¼‰ManageClientThreads

ç¼–å†™è·å–åœ¨çº¿ç”¨æˆ·ä¿¡æ¯åˆ—è¡¨çš„æ–¹æ³•

```java
// è¿”å›åœ¨æ–°ç”¨æˆ·åˆ—è¡¨
public static String getOnlineUser(){
    // éå† hashmap
    Iterator<String> iterator = hm.keySet().iterator();
    String onlineUserList = "";
    while(iterator.hasNext()){
        onlineUserList += iterator.next().toString() + " ";
    }
    return onlineUserList;
}
```

### ï¼ˆ2ï¼‰ServerConnectClientThread

åœ¨çº¿ç¨‹ç«¯æ¥æ”¶ä¿¡æ¯ï¼Œé€šè¿‡ä¸Šé¢ç¼–å†™å¥½çš„å¥½æ–¹æ³•æ‹¿åˆ°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼Œæ„å»º message å¯¹è±¡æŠŠä¿¡æ¯è¿”å›ç»™ç”¨æˆ·ç«¯

```java
@Override
public void run() { // çº¿ç¨‹ï¼Œå¯ä»¥ç»™å®¢æˆ·ç«¯å‘é€ä¿¡æ¯æˆ–è€…æ¥æ”¶å®¢æˆ·ç«¯çš„ä¿¡æ¯
    while (true) {
        System.out.println("æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯" + userId + "ä¿æŒé€šä¿¡ï¼Œè¯»å–æ•°æ®ä¸­...");
        try {
            ObjectInputStream ois = new ObjectInputStream(socket.getInputStream());
            Message message = (Message) ois.readObject();

            // æ¥æ”¶ç”¨æˆ·ç«¯å‘é€çš„ä¿¡æ¯ï¼Œåšç›¸åº”çš„å¤„ç†
            if (message.getMesType().equals(MessageType.MESSAGE_GET_ONLINE_FRIEND)) {
                System.out.println(message.getSender() + " è¦åœ¨çº¿ç”¨æˆ·åˆ—è¡¨");
                // é€šè¿‡æ–¹æ³•è·å–åˆ°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
                String onlineUser = ManageClientThreads.getOnlineUser();
                // æ„å»º message å¯¹è±¡ï¼Œå‡†å¤‡å›å¤æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
                Message message2 = new Message();
                // ä¸€å®šè¦æ³¨æ„ç±»ç±»å‹ï¼Œå¦åˆ™ç”¨æˆ·ç«¯æ¥æ”¶çš„ä¿¡æ¯ç±»å‹æ˜¯é”™çš„ï¼Œä¸šåŠ¡é€»è¾‘å°±ä¼šå‡ºç°é”™è¯¯
                message2.setMesType(MessageType.MESSAGE_RET_ONLINE_FRIEND);
                message2.setContent(onlineUser); // æ”¾å…¥åœ¨çº¿ç”¨æˆ·ä¿¡æ¯
                message2.setGetter(message.getSender());
                // æŠŠä¿¡æ¯å‘é€ç»™å®¢æˆ·ç«¯
                ObjectOutputStream oos = new ObjectOutputStream(socket.getOutputStream());
                oos.writeObject(message2);

            } else {
                System.out.println("å…¶ä»–ç±»å‹çš„messageï¼Œæš‚æ—¶ä¸å¤„ç†");
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

## ğŸ‰ å®Œç»“ï¼šåŠŸèƒ½æµ‹è¯• ğŸ‰

### 1. æœåŠ¡ç«¯

![alt text](æ‹‰å–åœ¨çº¿ç”¨æˆ·æµ‹è¯•ï¼šæœåŠ¡ç«¯.png)

### 2. å®¢æˆ·ç«¯

![alt text](æ‹‰å–åœ¨çº¿ç”¨æˆ·æµ‹è¯•ï¼šå®¢æˆ·ç«¯.png)
